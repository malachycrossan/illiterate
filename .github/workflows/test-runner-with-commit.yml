name: Code Testing Workflow

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Required to commit results back
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch all history for comparing changes
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Set up JDK
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
    
    - name: Install build tools
      run: |
        sudo apt-get update
        sudo apt-get install -y g++ gcc make
    
    - name: Get modified files
      id: changed-files
      run: |
        if [ "${{ github.event_name }}" == "pull_request" ]; then
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
        else
          BASE_SHA="${{ github.event.before }}"
        fi
        
        # Get modified/added files
        git diff --name-only $BASE_SHA ${{ github.sha }} > changed_files.txt
        
        # Filter for C++, C, and Java files
        grep -E '\.(cpp|cc|cxx|c|java)$' changed_files.txt > filtered_files.txt || true
        
        # Check for added/modified test files and add corresponding source files
        git diff --name-only --diff-filter=A $BASE_SHA ${{ github.sha }} > added_files.txt || true
        
        # Extract program names from test files and find corresponding source files
        grep -oE '[^/]+_test[0-9]+\.(in|out)$' added_files.txt 2>/dev/null | sed 's/_test[0-9]*\.\(in\|out\)$//' | sort | uniq > program_names.txt || true
        
        while IFS= read -r prog_name; do
          # Look for corresponding source files in the repo root and subdirectories
          if [ ! -z "$prog_name" ]; then
            find . -maxdepth 3 -type f \( -name "${prog_name}.cpp" -o -name "${prog_name}.c" -o -name "${prog_name}.cxx" -o -name "${prog_name}.cc" -o -name "${prog_name}.java" \) | grep -v test_results >> filtered_files.txt || true
          fi
        done < program_names.txt
        
        # Remove duplicates and sort
        sort -u filtered_files.txt -o filtered_files.txt
        
        if [ -s filtered_files.txt ]; then
          echo "has_changes=true" >> $GITHUB_OUTPUT
        else
          echo "has_changes=false" >> $GITHUB_OUTPUT
        fi
        
        cat filtered_files.txt
    
    - name: Run tests
      if: steps.changed-files.outputs.has_changes == 'true'
      run: |
        chmod +x .github/scripts/run_tests.sh
        .github/scripts/run_tests.sh
      continue-on-error: true  # Continue even if tests fail so we can commit results
    
    - name: Generate formatted reports
      if: steps.changed-files.outputs.has_changes == 'true'
      run: |
        chmod +x .github/scripts/generate_reports.sh
        .github/scripts/generate_reports.sh
    
    - name: Commit test results
      if: steps.changed-files.outputs.has_changes == 'true'
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
        # Create test-results directory if it doesn't exist
        mkdir -p test-results
        
        # Copy results
        cp -r test_results/* test-results/ 2>/dev/null || true
        
        # Add results
        git add test-results/
        
        # Commit if there are changes
        git diff --staged --quiet || git commit -m "Add test results for commit ${{ github.sha }}"
    
    - name: Push changes
      if: steps.changed-files.outputs.has_changes == 'true' && github.event_name == 'push'
      run: |
        git push
    
    - name: Comment PR with results
      if: steps.changed-files.outputs.has_changes == 'true' && github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          let comment = '## ðŸ§ª Test Results\n\n';
          
          try {
            const summary = fs.readFileSync('test_results/summary.md', 'utf8');
            comment += summary;
          } catch (e) {
            comment += 'Test results not available.';
          }
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });
    
    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: test_results/
    
    - name: Check test status
      if: steps.changed-files.outputs.has_changes == 'true'
      run: |
        if [ -f test_results/status.txt ]; then
          status=$(cat test_results/status.txt)
          if [ "$status" != "SUCCESS" ]; then
            echo "Tests failed!"
            exit 1
          fi
        fi
